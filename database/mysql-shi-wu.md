---
description: 这里以InnoDB存储引擎介绍，因为MySQL默认的存储引擎MyISAM并不支持事务。
---

# MySQL事务

## 1.定义与特性

把多条语句当做一个整体来执行的功能，称为数据库的事务。

**Atom（原子性）：**每一个事务都是一个不可分割的整体，是最小的逻辑工作单元，最小的原子，要么全部执行成功，要么全部失败，成功部分会回滚**。**

**Consistency（一致性）：**保证数据库从一个状态转移到另一个状态，一致性应当满足完成性约束，比如A有50元，B有40元，无论AB之间怎么转账，他们一共加起来应当是90元。

**Isolate（独立性）：**一个事务的执行不应当影响其它事务的执行。

**Durability（持久性）：**事务对于数据库的操作应当是永久的，对于已经提交的事务，即便系统出现故障也能够恢复事务对数据库的操作。

## 2.并发问题

　　脏读：读取到事务还没有提交的数据。

　　不可重复读：在一个**事务** 中，前后读取的数据不一致。

　　幻读：针对同一个查询语句，同一个查询条件，先后查询的结果不一致，仿佛出现了幻觉。

## 3.隔离级别

InnoDB有4种隔离级别，隔离效果依次增加：

**读未提交（READ**-**UNCOMMITTED）：**一个事务还没提交时，它做的变更就能被别的事务看到。

**读提交：（READ-COMMITTED，RC）**一个事务提交之后，它做的变更才会被其他事务看到，**解决脏读**。

**可重复读（REPEATABLE**-**READ，RR）：**一个事务执行过程中看到的数据，总是跟这个事务在启动时看到的数据是 一致的，**解决不可重复读**。

**序列化（串行化）（serializable）：**顾名思义是对于同一行记录，“写”会加“写锁”，“读”会加“读锁”。当出 现读写锁冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行，**解决幻读**。

MySQL InnoDB默认的隔离级别是：RR

查看隔离级别：select @@tx\_isolation        手动提交事务：start transaction       commit

## 4.当前读与快照读

MySQL InnoDB存储引擎，实现的是基于多版本的并发控制协议——MVCC，其好处就是读不加锁，读写不冲突。MVCC中读操作可以分为当前读与快照读。

当前读：读取的是最新版本, 并且对读取的记录加锁, 阻塞其他事务同时改动相同记录，避免出现安全问题。select...lock in share mode \(共享读锁\) select...for update ，update、,delete 、 insert

快照读：简单的select读，非阻塞读，不加锁

间隙锁：只有在Read Repeatable、Serializable隔离级别才有，就是锁定那些范围空间内的数据。对主键或唯一索引，如果select查询时where条件全部精确命中\(=或者in\)，这种场景本身就不会出现幻读，所以只会加行记录锁。

## 5.提问

　　**1.InnoDB可重复读隔离级别下如何避免幻读？**

* 表象：快照读（非阻塞读）伪MVCC 表象避免幻读，是RR下查找数据，第一次读取创建快照，后面读取都是读取本次快照，不论别的事务是否提交相关更改，我们都不知道，掩耳盗铃。
*   内在：next-key锁（行锁+gap锁）上了锁，其它事务无法修改锁定区间，不会出现幻读。

　　**2.RC RR 级别下的InnoDB的非阻塞读如何实现？**

　　**3.如何避免长事务对业务的影响？**

